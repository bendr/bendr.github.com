<!DOCTYPE html>
<html lang="en">
  <head>
    <title>⚐ Bender runtime</title>
    <meta charset="UTF-8">
    <style>
      html, body { height: 100%; margin: 0; }
      body, input { font-family: "Helvetica Neue", Helvetica, sans-serif; }
      body { font-size: 16px; background-color: #ccc; }
      input { font-size: 14px; }
      #back { position: absolute; right: 0; top: 0; }
      #back img { height: 32px; }
      #top { background-color: #444; color: white; height: 32px; }
      #tool-bar { background-color: #ccc; padding: 4px 8px; }
      #output { background-color: white; width: 100%; height: 0;
        overflow: auto; }
      svg { width: 100%; }
      #status { font-size: 12px; }
      #status.error { background-color: #ff4040; color: white; }
      #status.warning { background-color: #ff7f40; color: white; }
      #status.ok { background-color: #40ff40; }
      #status.info { background-color: #ccc; }
      #url-input { border: none; width: 24em; padding: 4px; }
      p { margin: 0; padding: 8px; }
      .CodeMirror { font-family: Menlo, monospace !important;
        background-color: white; font-size: 14px; }
      .hidden { display: none !important; }
    </style>
    <script src="flexo.js"></script>
    <script src="bender.js"></script>
    <script src="misc/codemirror.js"></script>
    <link href="misc/codemirror.css" rel="stylesheet">
    <script src="misc/xmlpure.js"></script>
  </head>
  <body>
    <div id="top">
      <p>⚐ Bender runtime</p>
      <div id="back"><a href="index.html"><img src="misc/benderw512.png"
          alt="Bender logo"></a></div>
    </div>
    <div id="tool-bar">
      <label>Enter an URL:
        <input type="text" onkeyup="url_enterp(event)" id="url-input"/>
      </label>
      or
      <input type="file" onchange="file_select(event)"/>
    </div>
    <div id="output">
      <div id="bender-target"></div>
    </div>
    <div id="status" class="warning">
      <p>Not ready.</p>
    </div>
    <div id="input">
    </div>
    <script>

      var EDITOR = CodeMirror(document.getElementById("input"),
        { lineNumbers: true, readOnly: true });
      var READER = new FileReader();
      var PARSER = new DOMParser();
      var STATUS_ = document.getElementById("status");
      var URL = document.getElementById("url-input");
      var OUTPUT = document.getElementById("output");
      var INPUT = document.getElementById("input");
      var TARGET = document.getElementById("bender-target");

      var y_STATUS, h_OUTPUT;

      var h_MAX = window.innerHeight - OUTPUT.offsetTop - STATUS_.offsetHeight;
      OUTPUT.style.height = "{0}px".fmt(h_MAX);
      EDITOR.getScrollerElement().style.height = "{0}px"
        .fmt(window.innerHeight - OUTPUT.offsetTop - h_MAX -
          STATUS_.offsetHeight);

      STATUS_.addEventListener("mousedown", function(event) {
          event.preventDefault();
          document.addEventListener("mousemove", drag_status_move, false);
          document.addEventListener("mouseup", drag_status_end, false);
          y_STATUS = event.clientY;
          h_OUTPUT = OUTPUT.offsetHeight;
          h_MAX = window.innerHeight - OUTPUT.offsetTop - STATUS_.offsetHeight;
        }, false);

      function drag_status_move(event)
      {
        var y = event.clientY;
        var h = Math.min(Math.max(0, h_OUTPUT + y - y_STATUS), h_MAX);
        OUTPUT.style.height = "{0}px".fmt(h);
        EDITOR.getScrollerElement().style.height = "{0}px"
          .fmt(window.innerHeight - OUTPUT.offsetTop - h - STATUS_.offsetHeight);
      }

      function drag_status_end(event)
      {
        document.removeEventListener("mousemove", drag_status_move, false);
        document.removeEventListener("mouseup", drag_status_end, false);
      }

      // Get args from the URL
      function get_args(argstr)
      {
        var args = flexo.get_args({ target: "bender-target", debug: 0 },
          argstr);
        bender.DEBUG_LEVEL = parseFloat(args.debug);
        args.TARGET = document.getElementById(args.target) || document.body;
        return args;
      }

      // Drag and drop a file anywhere (same as using the file chooser)
      document.body.addEventListener("dragover", dragover, false);
      document.body.addEventListener("drop", drop, false);

      function dragover(e)
      {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = "copy";
      }

      function drop(e)
      {
        e.preventDefault();
        e.stopPropagation();
        open_file(e.dataTransfer.files[0]);
      }

      // Reading a file from the file chooser
      function file_select(event) { open_file(event.target.files[0]); }

      // Reading a file from the file chooser or dropped in the window
      function open_file(file)
      {
        if (file) {
          warn("Loading {0}...".fmt(file.name));
          ARGS.TARGET.innerHTML = "";
          READER.onerror = function(e) {
            error("Could not read file as text.");
          };
          READER.onload = function(e) {
            try {
              EDITOR.setValue(e.target.result);
            } catch(e) {
              bender.warn(e);
            }
            var doc = PARSER.parseFromString(e.target.result, "text/xml");
            if (doc && doc.documentElement) {
              try {
                var context = bender.create_context(document);
                var app = context.import(doc.documentElement);
                app.addEventListener("@loaded", function() {
                    var instance = app.instantiate();
                    if (instance.render(ARGS.TARGET, true)) {
                      ok("OK");
                      flexo.notify(instance, "@ready");
                    } else {
                      warn("Component {0} has no view.".fmt(instance.hash));
                    }
                  }, false);
              } catch (e) {
                error(e.message);
                ARGS.TARGET.appendChild(document.importNode(doc.documentElement,
                  true));
              }
            } else {
              error("Could not read file as XML.");
            }
          };
          READER.readAsText(file);
        }
      }

      function url_enterp(e)
      {
        if (e.keyCode === 13) {
          var args = get_args("app={0}".fmt(flexo.normalize(e.target.value)));
          open_url(args);
        }
      }

      // Open a file from a URL
      function open_url(args)
      {
        warn("Loading {0}...".fmt(args.app));
        flexo.request_uri(args.app, function(req) {
            args.TARGET.innerHTML = "";
            EDITOR.setValue(req.responseText);
            var context = bender.create_context(document, args.app);
            var app = context.import(req.responseXML.documentElement);
            app.addEventListener("@loaded", function() {
                var instance = app.instantiate();
                if (instance.render(args.TARGET, true)) {
                  for (var a in args) {
                    if (args.hasOwnProperty(a)) {
                      if (a.substr(0, 2) === "e:") {
                        prop_name = "$" + flexo.undash(a.substr(2));
                        instance[prop_name] = args[a];
                      } else if (a.substr(0, 2) === "f:") {
                        prop_name = "$" + flexo.undash(a.substr(2));
                        instance[prop_name] = parseFloat(args[a]);
                      } else if (a.substr(0, 2) === "b:") {
                        prop_name = "$" + flexo.undash(a.substr(2));
                        instance[prop_name] = bender.is_true(args[a]);
                      } else if (a.substr(0, 1) === "$") {
                        instance[a] = args[a];
                      }
                    }
                  }
                  ok("OK");
                  flexo.notify(instance, "@ready");
                } else {
                  warn("Component has no view.");
                }
              }, false);
          });
      }

      window.onerror = function(e) { error(e); }

      function set_status(class_, message)
      {
        STATUS_.className = class_;
        STATUS_.innerHTML = "<p>{0}</p>".fmt(message);
      }

      function info(message) { set_status("info", message); }
      function ok(message) { set_status("ok", message); }
      function warn(message) { set_status("warning", message); }
      function error(message) { set_status("error", message); }

      var ARGS = get_args();
      if (ARGS.app) {
        URL.value = ARGS.app;
        open_url(ARGS);
      } else {
        info("Please select a file to run.");
      }

    </script>
  </body>
</html>
